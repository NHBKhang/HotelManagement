<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

    <head>
        <title th:text="${serviceBooking.id != null} ? 'Chỉnh sửa Đặt dịch vụ - Quản lý khách sạn' : 'Thêm Đặt dịch vụ - Quản lý khách sạn'">
            Quản lý khách sạn
        </title>
    <th:block th:replace="base :: head"></th:block>
    <style>
        .quantity-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.2s ease-in-out;
        }

        .quantity-btn:hover {
            background-color: #0d6efd;
            color: white;
        }

        #unitDisplay {
            font-size: 14px;
            background: #f8f9fa;
            font-weight: 500;
        }
    </style>
</head>

<body>
    <div th:replace="base :: layout(~{::content})">
        <div th:fragment="content">
            <div class="container">
                <h2 class="text-center mb-3">
                    <span th:if="${serviceBooking.id != null}">
                        <i class="fa-solid fa-pen-to-square me-2"></i> Chỉnh sửa Đặt dịch vụ
                    </span>
                    <span th:unless="${serviceBooking.id != null}">
                        <i class="fa-solid fa-plus-circle me-2"></i> Thêm Đặt dịch vụ
                    </span>
                </h2>

                <form th:action="@{/service-bookings/save}" th:object="${serviceBooking}" method="post" 
                      id="serviceBookingForm" class="styled-form">
                    <input type="hidden" th:if="${serviceBooking.id != null}" th:field="*{id}">
                    <input type="hidden" th:if="${serviceBooking.id != null}" th:field="*{code}">

                    <div class="my-2 d-flex gap-2">
                        <button type="submit" class="btn btn-success">
                            <i class="fa-solid fa-save me-1"></i>
                            <span th:text="${serviceBooking.id != null} ? 'Cập nhật' : 'Lưu'"></span>
                        </button>

                        <a th:href="@{/service-bookings}" class="btn btn-secondary">
                            <i class="fa-solid fa-circle-left me-1"></i> Trở về
                        </a>
                    </div>

                    <div class="row">
                        <div class="col-md-8">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fas fa-info-circle"></i> Thông tin Đặt dịch vụ</h5>
                                </div>
                                <div class="p-4 border rounded shadow-sm bg-light">
                                    <div class="mb-3" th:if="${serviceBooking.id != null}">
                                        <label class="form-label fw-bold">Mã</label>
                                        <span id="code"
                                              th:text="*{code}" 
                                              class="badge bg-primary fs-5 fw-bold">
                                        </span>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Booking <span class="text-danger">*</span></label>
                                        <div id="booking-dropdown">
                                            <input id="booking" th:field="*{booking.id}" required/>
                                        </div>
                                        <div class="text-danger" th:if="${#fields.hasErrors('booking')}" th:errors="*{booking}"></div>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">Dịch vụ <span class="text-danger">*</span></label>
                                        <div id="service-dropdown">
                                            <input id="service" th:field="*{service.id}" required/>
                                        </div>
                                        <div class="text-danger" th:if="${#fields.hasErrors('service')}" th:errors="*{service}"></div>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">Số lượng <span class="text-danger">*</span></label>
                                        <div class="input-group">
                                            <button type="button" class="btn btn-outline-secondary quantity-btn me-2" onclick="changeQuantity( - 1)">
                                                <i class="fas fa-minus"></i>
                                            </button>
                                            <input type="number" class="form-control text-center" id="quantity" name="quantity"
                                                   th:value="${serviceBooking.quantity ?: 1}" min="1" max="100" required oninput="calculateTotal()">
                                            <button type="button" class="btn btn-outline-secondary quantity-btn ms-2" onclick="changeQuantity(1)">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                            <span class="input-group-text" id="unitDisplay">Đơn vị</span>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-6">
                                            <label class="form-label">Đơn giá</label>
                                            <div class="form-control bg-light" id="unitPriceDisplay">0đ</div>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Tổng tiền</label>
                                            <div class="form-control bg-success text-white fw-bold fs-5" id="totalPriceDisplay">0đ</div>
                                            <input type="hidden" id="totalPrice" name="totalPrice" th:value="${serviceBooking.totalPrice ?: 0}">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="card mb-3" id="bookingInfoCard" style="display: none;">
                                <div class="card-header bg-info text-white">
                                    <h6 class="mb-0"><i class="fas fa-info-circle"></i> Thông tin Booking</h6>
                                </div>
                                <div class="card-body small">
                                    <p><strong>Khách hàng:</strong> <span id="customerName">-</span></p>
                                    <p><strong>Email:</strong> <span id="customerEmail">-</span></p>
                                    <p><strong>Phòng:</strong> <span id="roomInfo">-</span></p>
                                    <p><strong>Check-in:</strong> <span id="checkInDate">-</span></p>
                                    <p><strong>Check-out:</strong> <span id="checkOutDate">-</span></p>
                                    <p><strong>Số người:</strong> <span id="guests">-</span></p>
                                </div>
                            </div>

                            <div class="card mb-3" id="serviceInfoCard" style="display: none;">
                                <div class="card-header bg-warning text-white">
                                    <h6 class="mb-0"><i class="fas fa-concierge-bell"></i> Thông tin Dịch vụ</h6>
                                </div>
                                <div class="card-body small">
                                    <p><strong>Mô tả:</strong> <span id="serviceDescription">-</span></p>
                                    <p><strong>Đơn vị:</strong> <span id="serviceUnit">-</span></p>
                                    <p><strong>Giá:</strong> <span id="servicePrice" class="fw-bold text-success">-</span></p>
                                </div>
                            </div>

                            <div class="card">
                                <div class="card-header bg-success text-white">
                                    <h6 class="mb-0"><i class="fas fa-calculator"></i> Tổng kết</h6>
                                </div>
                                <div class="card-body">
                                    <p><strong>Số lượng:</strong> <span id="summaryQuantity">0</span></p>
                                    <p><strong>Đơn giá:</strong> <span id="summaryUnitPrice">0đ</span></p>
                                    <p class="border-top pt-2 fw-bold fs-5 text-success">Tổng: <span id="summaryTotal">0đ</span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        let currentServicePrice = 0;
        function loadBookingInfo() {
        const option = document.querySelector('#bookingId option:checked');
        const card = document.getElementById('bookingInfoCard');
        if (option && option.value) {
        document.getElementById('customerName').textContent = option.dataset.userName;
        document.getElementById('customerEmail').textContent = option.dataset.userEmail;
        document.getElementById('roomInfo').textContent = option.dataset.roomNumber + ' - ' + option.dataset.roomType;
        document.getElementById('checkInDate').textContent = option.dataset.checkIn;
        document.getElementById('checkOutDate').textContent = option.dataset.checkOut;
        document.getElementById('guests').textContent = option.dataset.guests + ' người';
        card.style.display = 'block';
        } else
                card.style.display = 'none';
        }

        function updateServiceInfo() {
        const option = document.querySelector('#serviceId option:checked');
        const card = document.getElementById('serviceInfoCard');
        if (option && option.value) {
        currentServicePrice = parseFloat(option.dataset.price || 0);
        const unit = option.dataset.unit || 'Đơn vị';
        document.getElementById('serviceDescription').textContent = option.dataset.description || '-';
        document.getElementById('serviceUnit').textContent = unit;
        document.getElementById('servicePrice').textContent = formatCurrency(currentServicePrice);
        document.getElementById('unitDisplay').textContent = unit;
        document.getElementById('unitPriceDisplay').textContent = formatCurrency(currentServicePrice);
        card.style.display = 'block';
        calculateTotal();
        } else {
        card.style.display = 'none';
        currentServicePrice = 0;
        document.getElementById('unitDisplay').textContent = 'Đơn vị';
        document.getElementById('unitPriceDisplay').textContent = '0đ';
        calculateTotal();
        }
        }

        function changeQuantity(delta) {
        const input = document.getElementById('quantity');
        let value = parseInt(input.value || 1) + delta;
        value = Math.max(1, Math.min(100, value));
        input.value = value;
        calculateTotal();
        }

        function calculateTotal() {
        const quantity = parseInt(document.getElementById('quantity').value || 1);
        const total = quantity * currentServicePrice;
        document.getElementById('totalPrice').value = total;
        document.getElementById('totalPriceDisplay').textContent = formatCurrency(total);
        document.getElementById('summaryQuantity').textContent = quantity;
        document.getElementById('summaryUnitPrice').textContent = formatCurrency(currentServicePrice);
        document.getElementById('summaryTotal').textContent = formatCurrency(total);
        }

        function formatCurrency(amount) {
        return new Intl.NumberFormat('vi-VN').format(amount) + 'đ';
        }

        document.addEventListener('DOMContentLoaded', () => {
        if (document.getElementById('bookingId').value)
                loadBookingInfo();
        if (document.getElementById('serviceId').value)
                updateServiceInfo();
        calculateTotal();
        });
    </script>
    <script th:inline="javascript">
        const bookingIdFromParams = getParam("bookingId");
        
        renderDynamicDropdown({
        containerId: 'booking-dropdown',
                apiUrl: [[@{/api/bookings}]],
                buildOptionText: item => {
                const date = `${new Date(item.checkInDate).toLocaleDateString('vi-VN')} - ${new Date(item.checkOutDate).toLocaleDateString('vi-VN')}`;
                return `${item.code} - ${item.user.fullName} (${date})`;
                },
                value: /*[[${serviceBooking.booking}]]*/,
                defaultId: bookingIdFromParams,
                required: true,
        });
        renderDynamicDropdown({
        containerId: 'service-dropdown',
                apiUrl: [[@{/api/services}]],
                buildOptionText: item => `${item.name} - ${item.price}đ/${item.unit}`,
                value: /*[[${serviceBooking.service}]]*/,
                required: true,
        });
    </script>
</body>
</html>
