<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <title>Thống kê Phòng - Quản lý khách sạn</title>
    <th:block th:replace="base :: head"></th:block>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
    <div th:replace="base :: layout(~{::content})">
        <div th:fragment="content">
            <div class="container-fluid">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2><i class="fas fa-bed"></i> Thống kê Phòng</h2>
                    <div>
                        <a th:href="@{/stats}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> Quay lại Dashboard
                        </a>
                    </div>
                </div>

                <!-- Summary Cards -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card bg-primary text-white">
                            <div class="card-body text-center">
                                <h2 th:text="${totalRooms ?: 0}">0</h2>
                                <p class="mb-0">Tổng số phòng</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-success text-white">
                            <div class="card-body text-center">
                                <h2 th:text="${occupancyStats.available ?: 0}">0</h2>
                                <p class="mb-0">Phòng trống</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-danger text-white">
                            <div class="card-body text-center">
                                <h2 th:text="${occupancyStats.occupied ?: 0}">0</h2>
                                <p class="mb-0">Phòng đã đặt</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-warning text-white">
                            <div class="card-body text-center">
                                <h2 th:text="${occupancyStats.maintenance ?: 0}">0</h2>
                                <p class="mb-0">Đang bảo trì</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <!-- Room Status Chart -->
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-chart-pie"></i> Tình trạng phòng</h5>
                            </div>
                            <div class="card-body">
                                <canvas id="roomStatusChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Occupancy Rate -->
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-chart-bar"></i> Tỷ lệ lấp đầy</h5>
                            </div>
                            <div class="card-body text-center">
                                <div class="mb-3">
                                    <h1 class="display-4 text-primary" th:text="${#numbers.formatDecimal((occupancyStats.occupied ?: 0) * 100.0 / (totalRooms ?: 1), 1, 'POINT', 1, 'POINT')} + '%'">0%</h1>
                                    <p class="text-muted">Tỷ lệ lấp đầy hiện tại</p>
                                </div>
                                <div class="progress mb-3" style="height: 20px;">
                                    <div class="progress-bar bg-danger" role="progressbar" 
                                         th:style="'width: ' + ${(occupancyStats.occupied ?: 0) * 100.0 / (totalRooms ?: 1)} + '%'"
                                         th:text="${(occupancyStats.occupied ?: 0) * 100.0 / (totalRooms ?: 1)} + '%'">0%</div>
                                </div>
                                <div class="row text-center">
                                    <div class="col">
                                        <small class="text-success">Trống: <span th:text="${occupancyStats.available ?: 0}">0</span></small>
                                    </div>
                                    <div class="col">
                                        <small class="text-danger">Đặt: <span th:text="${occupancyStats.occupied ?: 0}">0</span></small>
                                    </div>
                                    <div class="col">
                                        <small class="text-warning">Bảo trì: <span th:text="${occupancyStats.maintenance ?: 0}">0</span></small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Room List -->
                <div class="row mt-4">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-list"></i> Danh sách phòng</h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Mã phòng</th>
                                                <th>Loại phòng</th>
                                                <th>Giá/đêm</th>
                                                <th>Sức chứa</th>
                                                <th>Trạng thái</th>
                                                <th>Thao tác</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr th:each="room : ${rooms}">
                                                <td>
                                                    <a th:href="@{/rooms/{id}(id=${room.id})}" 
                                                       th:text="${room.roomNumber}" class="text-decoration-none fw-bold">P101</a>
                                                </td>
                                                <td th:text="${room.roomType.name}">Deluxe</td>
                                                <td th:text="${#numbers.formatDecimal(room.roomType.pricePerNight ?: 0, 0, 'COMMA', 0, 'POINT')} + 'đ'">500,000đ</td>
                                                <td>
                                                    <i class="fas fa-users text-primary"></i>
                                                    <span th:text="${room.roomType.maxGuests ?: 1}">2</span>
                                                </td>
                                                <td>
                                                    <span class="badge" 
                                                          th:classappend="${room.status.badgeClass}"
                                                          th:text="${room.status.description}">Trống</span>
                                                </td>
                                                <td>
                                                    <div class="btn-group" role="group">
                                                        <a th:href="@{/rooms/{id}(id=${room.id})}" 
                                                           class="btn btn-sm btn-outline-primary" title="Chi tiết">
                                                            <i class="fas fa-eye"></i>
                                                        </a>
                                                        <a th:href="@{/rooms/edit/{id}(id=${room.id})}" 
                                                           class="btn btn-sm btn-outline-warning" title="Sửa">
                                                            <i class="fas fa-edit"></i>
                                                        </a>
                                                    </div>
                                                </td>
                                            </tr>
                                            <tr th:if="${#lists.isEmpty(rooms)}">
                                                <td colspan="6" class="text-center text-muted">Không có phòng nào</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Room Type Statistics -->
                <div class="row mt-4">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-chart-bar"></i> Thống kê theo loại phòng</h5>
                            </div>
                            <div class="card-body">
                                <canvas id="roomTypeChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Actions -->
                <div sec:authorize="hasAnyRole('ADMIN', 'MANAGER')" class="row mt-4">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-tools"></i> Thao tác nhanh</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3">
                                        <a th:href="@{/rooms}" class="btn btn-outline-primary w-100">
                                            <i class="fas fa-list"></i> Quản lý phòng
                                        </a>
                                    </div>
                                    <div class="col-md-3">
                                        <a th:href="@{/rooms/add}" class="btn btn-outline-success w-100">
                                            <i class="fas fa-plus"></i> Thêm phòng mới
                                        </a>
                                    </div>
                                    <div class="col-md-3">
                                        <a th:href="@{/room-types}" class="btn btn-outline-info w-100">
                                            <i class="fas fa-cogs"></i> Quản lý loại phòng
                                        </a>
                                    </div>
                                    <div class="col-md-3">
                                        <button onclick="exportRoomData()" class="btn btn-outline-warning w-100">
                                            <i class="fas fa-download"></i> Xuất báo cáo
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        // Room Status Chart
        const occupancyStats = /*[[${occupancyStats}]]*/ {};
        
        if (occupancyStats && Object.keys(occupancyStats).length > 0) {
            const statusLabels = ['Trống', 'Đã đặt', 'Bảo trì'];
            const statusValues = [
                occupancyStats.available || 0,
                occupancyStats.occupied || 0,
                occupancyStats.maintenance || 0
            ];
            const statusColors = ['#28a745', '#dc3545', '#ffc107'];

            new Chart(document.getElementById('roomStatusChart'), {
                type: 'doughnut',
                data: {
                    labels: statusLabels,
                    datasets: [{
                        data: statusValues,
                        backgroundColor: statusColors,
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // Room Type Chart
        const rooms = /*[[${rooms}]]*/ [];
        
        if (rooms && rooms.length > 0) {
            // Group rooms by room type
            const roomTypeCount = {};
            rooms.forEach(room => {
                const typeName = room.roomType.name;
                roomTypeCount[typeName] = (roomTypeCount[typeName] || 0) + 1;
            });

            const typeLabels = Object.keys(roomTypeCount);
            const typeValues = Object.values(roomTypeCount);
            const typeColors = ['#007bff', '#28a745', '#ffc107', '#dc3545', '#6f42c1', '#fd7e14'];

            new Chart(document.getElementById('roomTypeChart'), {
                type: 'bar',
                data: {
                    labels: typeLabels,
                    datasets: [{
                        label: 'Số lượng phòng',
                        data: typeValues,
                        backgroundColor: typeColors.slice(0, typeLabels.length),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        function exportRoomData() {
            window.open('/stats/api/rooms?format=csv', '_blank');
        }
    </script>
</body>
</html>
