<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <title>Lịch Booking - Quản lý khách sạn</title>
    <th:block th:replace="base :: head"></th:block>
    <style>
        .calendar-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .calendar-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px 8px 0 0;
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #e9ecef;
            padding: 1px;
        }
        
        .calendar-day {
            background: white;
            min-height: 120px;
            padding: 8px;
            position: relative;
            border: 1px solid #dee2e6;
        }
        
        .calendar-day.other-month {
            background: #f8f9fa;
            color: #6c757d;
        }
        
        .calendar-day.today {
            background: #fff3cd;
            border-color: #ffc107;
        }
        
        .calendar-day-number {
            font-weight: bold;
            margin-bottom: 4px;
        }
        
        .booking-item {
            background: #007bff;
            color: white;
            padding: 2px 4px;
            margin: 1px 0;
            border-radius: 3px;
            font-size: 10px;
            cursor: pointer;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .booking-item.status-pending { background: #6c757d; }
        .booking-item.status-processing { background: #fd7e14; }
        .booking-item.status-confirmed { background: #28a745; }
        .booking-item.status-checked-in { background: #17a2b8; }
        .booking-item.status-checked-out { background: #6f42c1; }
        .booking-item.status-cancelled { background: #dc3545; }
        
        .calendar-weekday {
            background: #495057;
            color: white;
            padding: 10px;
            text-align: center;
            font-weight: bold;
        }
        
        .room-filter {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .legend-color {
            width: 20px;
            height: 15px;
            border-radius: 3px;
        }
    </style>
</head>

<body>
    <div th:replace="base :: layout(~{::content})">
        <div th:fragment="content">
            <div class="container-fluid">
                <div class="calendar-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h2 class="mb-1"><i class="fas fa-calendar-alt"></i> Lịch Booking</h2>
                            <p class="mb-0">Xem tổng quan các booking theo thời gian</p>
                        </div>
                        <div class="d-flex gap-2">
                            <a th:href="@{/bookings}" class="btn btn-light">
                                <i class="fas fa-list"></i> Danh sách
                            </a>
                            <a th:href="@{/bookings/add}" class="btn btn-success">
                                <i class="fas fa-plus"></i> Tạo booking
                            </a>
                        </div>
                    </div>
                </div>

                <div class="row mt-4">
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-filter"></i> Bộ lọc</h5>
                            </div>
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <button class="btn btn-outline-primary btn-sm" onclick="previousMonth()">
                                        <i class="fas fa-chevron-left"></i>
                                    </button>
                                    <h6 class="mb-0" id="currentMonth">Tháng 1, 2024</h6>
                                    <button class="btn btn-outline-primary btn-sm" onclick="nextMonth()">
                                        <i class="fas fa-chevron-right"></i>
                                    </button>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Chuyển đến:</label>
                                    <input type="month" id="monthPicker" class="form-control" onchange="goToMonth()">
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Lọc theo phòng:</label>
                                    <div class="room-filter">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="allRooms" checked onchange="toggleAllRooms()">
                                            <label class="form-check-label fw-bold" for="allRooms">Tất cả phòng</label>
                                        </div>
                                        <hr class="my-2">
                                        <div th:each="room : ${rooms}">
                                            <div class="form-check">
                                                <input class="form-check-input room-checkbox" type="checkbox" 
                                                       th:id="'room-' + ${room.id}" th:value="${room.id}" checked 
                                                       onchange="filterByRoom()">
                                                <label class="form-check-label" th:for="'room-' + ${room.id}">
                                                    <span th:text="${room.roomNumber}">Phòng 101</span>
                                                    <small class="text-muted" th:text="'(' + ${room.roomType.name} + ')'">Standard</small>
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Lọc theo trạng thái:</label>
                                    <div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input status-checkbox" type="checkbox" id="status-all" checked onchange="toggleAllStatuses()">
                                            <label class="form-check-label" for="status-all">Tất cả</label>
                                        </div>
                                    </div>
                                    <div>
                                        <div class="form-check">
                                            <input class="form-check-input status-filter" type="checkbox" id="status-pending" value="PENDING" checked>
                                            <label class="form-check-label" for="status-pending">Chờ xác nhận</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input status-filter" type="checkbox" id="status-processing" value="PROCESSING" checked>
                                            <label class="form-check-label" for="status-processing">Chờ xử lý</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input status-filter" type="checkbox" id="status-confirmed" value="CONFIRMED" checked>
                                            <label class="form-check-label" for="status-confirmed">Đã xác nhận</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input status-filter" type="checkbox" id="status-checked-in" value="CHECKED_IN" checked>
                                            <label class="form-check-label" for="status-checked-in">Đang ở</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input status-filter" type="checkbox" id="status-checked-out" value="CHECKED_OUT" checked>
                                            <label class="form-check-label" for="status-checked-out">Đã trả phòng</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input status-filter" type="checkbox" id="status-cancelled" value="CANCELLED" checked>
                                            <label class="form-check-label" for="status-cancelled">Đã hủy</label>
                                        </div>
                                    </div>
                                </div>

                                <button class="btn btn-primary w-100" onclick="goToToday()">
                                    <i class="fas fa-calendar-day"></i> Hôm nay
                                </button>
                            </div>
                        </div>

                        <div class="card mt-3">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="fas fa-chart-pie"></i> Thống kê tháng</h6>
                            </div>
                            <div class="card-body">
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Tổng booking:</span>
                                    <span class="fw-bold" id="totalBookings">0</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Đã xác nhận:</span>
                                    <span class="text-success fw-bold" id="confirmedBookings">0</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Đang ở:</span>
                                    <span class="text-primary fw-bold" id="checkedInBookings">0</span>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span>Tỷ lệ lấp đầy:</span>
                                    <span class="text-info fw-bold" id="occupancyRate">0%</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-9">
                        <div class="calendar-container">
                            <div class="calendar-grid">
                                <div class="calendar-weekday">CN</div>
                                <div class="calendar-weekday">T2</div>
                                <div class="calendar-weekday">T3</div>
                                <div class="calendar-weekday">T4</div>
                                <div class="calendar-weekday">T5</div>
                                <div class="calendar-weekday">T6</div>
                                <div class="calendar-weekday">T7</div>
                            </div>
                            
                            <div class="calendar-grid" id="calendarDaysGrid">
                                <div id="calendarDays"></div>
                            </div>
                        </div>

                        <!-- Legend -->
                        <div class="legend">
                            <div class="legend-item">
                                <div class="legend-color" style="background: #6c757d;"></div>
                                <span>Chờ xác nhận</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: #fd7e14;"></div>
                                <span>Chờ xử lý</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: #28a745;"></div>
                                <span>Đã xác nhận</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: #17a2b8;"></div>
                                <span>Đang ở</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: #6f42c1;"></div>
                                <span>Đã trả phòng</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: #dc3545;"></div>
                                <span>Đã hủy</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal fade" id="bookingModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Chi tiết Booking</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body" id="bookingModalBody">
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
<!--                            <a id="viewBookingLink" href="#" class="btn btn-primary">Xem chi tiết</a>-->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        // Get bookings data from server
        const bookingsData = /*[[${bookings}]]*/ [];
        const roomsData = /*[[${rooms}]]*/ [];

        let currentDate = new Date();
        let displayedBookings = [...bookingsData];

        document.addEventListener('DOMContentLoaded', function() {
            updateCalendar();
            updateStatistics();
            
            const monthPicker = document.getElementById('monthPicker');
            const year = currentDate.getFullYear();
            const month = String(currentDate.getMonth() + 1).padStart(2, '0');
            monthPicker.value = `${year}-${month}`;
        });

        function updateCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            const monthNames = ['Tháng 1', 'Tháng 2', 'Tháng 3', 'Tháng 4', 'Tháng 5', 'Tháng 6',
                              'Tháng 7', 'Tháng 8', 'Tháng 9', 'Tháng 10', 'Tháng 11', 'Tháng 12'];
            document.getElementById('currentMonth').textContent = `${monthNames[month]}, ${year}`;
            
            // Generate calendar days
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const firstDayOfWeek = firstDay.getDay();
            const daysInMonth = lastDay.getDate();

            let calendarHTML = '';
            
            // Calculate start date (previous month's days to fill the first week)
            const startDate = new Date(year, month, 1 - firstDayOfWeek);
            
            // Generate 6 weeks (42 days total)
            for (let i = 0; i < 42; i++) {
                const cellDate = new Date(startDate);
                cellDate.setDate(startDate.getDate() + i);
                
                const isCurrentMonth = cellDate.getMonth() === month;
                const isToday = isDateToday(cellDate);
                
                let dayClass = 'calendar-day';
                if (!isCurrentMonth) dayClass += ' other-month';
                if (isToday) dayClass += ' today';
                
                const bookingsForDay = getBookingsForDate(cellDate);
                
                calendarHTML += `
                    <div class="${dayClass}">
                        <div class="calendar-day-number">${cellDate.getDate()}</div>
                        ${bookingsForDay.map(booking => `
                            <div class="booking-item status-${booking.status.toLowerCase()}"
                                 onclick="showBookingModal(${booking.id})"
                                 title="${booking.code} - ${booking.room.roomNumber}">
                                ${booking.code}
                            </div>
                        `).join('')}
                    </div>
                `;
                
                // Stop after we've filled enough weeks and passed the current month
                if (i >= 34 && !isCurrentMonth) break;
            }
            
            // Update the calendar grid container to use grid layout
            const calendarDaysGrid = document.getElementById('calendarDaysGrid');
            calendarDaysGrid.innerHTML = calendarHTML;
        }

        function getBookingsForDate(date) {
            return displayedBookings.filter(booking => {
                const checkIn = new Date(booking.checkInDate);
                const checkOut = new Date(booking.checkOutDate);
                return date >= checkIn && date < checkOut;
            });
        }

        function isDateToday(date) {
            const today = new Date();
            return date.toDateString() === today.toDateString();
        }

        function previousMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            updateCalendar();
            updateStatistics();
            updateMonthPicker();
        }

        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            updateCalendar();
            updateStatistics();
            updateMonthPicker();
        }

        function goToMonth() {
            const monthPicker = document.getElementById('monthPicker');
            const [year, month] = monthPicker.value.split('-');
            currentDate = new Date(parseInt(year), parseInt(month) - 1, 1);
            updateCalendar();
            updateStatistics();
        }

        function goToToday() {
            currentDate = new Date();
            updateCalendar();
            updateStatistics();
            updateMonthPicker();
        }

        function updateMonthPicker() {
            const monthPicker = document.getElementById('monthPicker');
            const year = currentDate.getFullYear();
            const month = String(currentDate.getMonth() + 1).padStart(2, '0');
            monthPicker.value = `${year}-${month}`;
        }

        function toggleAllRooms() {
            const allRoomsChecked = document.getElementById('allRooms').checked;
            const roomCheckboxes = document.querySelectorAll('.room-checkbox');
            
            roomCheckboxes.forEach(checkbox => {
                checkbox.checked = allRoomsChecked;
            });
            
            filterByRoom();
        }

        function filterByRoom() {
            const selectedRooms = Array.from(document.querySelectorAll('.room-checkbox:checked'))
                                      .map(cb => parseInt(cb.value));
            
            if (selectedRooms.length === 0) {
                displayedBookings = [];
            } else {
                displayedBookings = bookingsData.filter(booking => 
                    selectedRooms.includes(booking.room.id)
                );
            }
            
            // Update all rooms checkbox
            const allRoomCheckboxes = document.querySelectorAll('.room-checkbox');
            const checkedRoomCheckboxes = document.querySelectorAll('.room-checkbox:checked');
            document.getElementById('allRooms').checked = allRoomCheckboxes.length === checkedRoomCheckboxes.length;
            
            applyStatusFilter();
            updateCalendar();
            updateStatistics();
        }

        function toggleAllStatuses() {
            const allStatusesChecked = document.getElementById('status-all').checked;
            const statusCheckboxes = document.querySelectorAll('.status-filter');
            
            statusCheckboxes.forEach(checkbox => {
                checkbox.checked = allStatusesChecked;
            });
            
            applyStatusFilter();
        }

        function applyStatusFilter() {
            const selectedStatuses = Array.from(document.querySelectorAll('.status-filter:checked'))
                                           .map(cb => cb.value);
            
            if (selectedStatuses.length === 0) {
                displayedBookings = [];
            } else {
                const roomFilteredBookings = getRoomFilteredBookings();
                displayedBookings = roomFilteredBookings.filter(booking => 
                    selectedStatuses.includes(booking.status)
                );
            }
            
            updateCalendar();
            updateStatistics();
        }

        function getRoomFilteredBookings() {
            const selectedRooms = Array.from(document.querySelectorAll('.room-checkbox:checked'))
                                      .map(cb => parseInt(cb.value));
            
            if (selectedRooms.length === 0) {
                return [];
            }
            
            return bookingsData.filter(booking => selectedRooms.includes(booking.room.id));
        }

        function updateStatistics() {
            const monthBookings = getBookingsForMonth();
            
            document.getElementById('totalBookings').textContent = monthBookings.length;
            document.getElementById('confirmedBookings').textContent = 
                monthBookings.filter(b => b.status === 'CONFIRMED').length;
            document.getElementById('checkedInBookings').textContent = 
                monthBookings.filter(b => b.status === 'CHECKED_IN').length;
            
            // Calculate occupancy rate (simplified)
            const totalRoomDays = roomsData.length * new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0).getDate();
            const occupiedDays = monthBookings.reduce((total, booking) => {
                const checkIn = new Date(booking.checkInDate);
                const checkOut = new Date(booking.checkOutDate);
                const days = Math.ceil((checkOut - checkIn) / (1000 * 60 * 60 * 24));
                return total + days;
            }, 0);
            
            const occupancyRate = totalRoomDays > 0 ? Math.round((occupiedDays / totalRoomDays) * 100) : 0;
            document.getElementById('occupancyRate').textContent = occupancyRate + '%';
        }

        function getBookingsForMonth() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const monthStart = new Date(year, month, 1);
            const monthEnd = new Date(year, month + 1, 0);
            
            return displayedBookings.filter(booking => {
                const checkIn = new Date(booking.checkInDate);
                const checkOut = new Date(booking.checkOutDate);
                return (checkIn <= monthEnd && checkOut >= monthStart);
            });
        }

        function showBookingModal(bookingId) {
            const booking = bookingsData.find(b => b.id === bookingId);
            if (!booking) return;
            
            const statusInfo = getStatusInfo(booking.status);
            
            const modalBody = document.getElementById('bookingModalBody');
            modalBody.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Thông tin Booking</h6>
                        <p><strong>Mã:</strong> ${booking.code}</p>
                        <p><strong>Khách hàng:</strong> ${booking.user.firstName} ${booking.user.lastName}</p>
                        <p><strong>Email:</strong> ${booking.user.email}</p>
                        <p><strong>Phòng:</strong> ${booking.room.roomNumber} (${booking.room.roomType.name})</p>
                    </div>
                    <div class="col-md-6">
                        <h6>Thời gian</h6>
                        <p><strong>Nhận phòng:</strong> ${formatDate(booking.checkInDate)}</p>
                        <p><strong>Trả phòng:</strong> ${formatDate(booking.checkOutDate)}</p>
                        <p><strong>Số khách:</strong> ${booking.guests || 1}</p>
                        <p><strong>Trạng thái:</strong> <span class="badge bg-${statusInfo.color}">${statusInfo.text}</span></p>
                    </div>
                </div>
                ${booking.specialRequest ? `<div class="mt-3"><strong>Yêu cầu đặc biệt:</strong><br>${booking.specialRequest}</div>` : ''}
            `;
            
            // document.getElementById('viewBookingLink').href = `/bookings/${bookingId}`;
            
            new bootstrap.Modal(document.getElementById('bookingModal')).show();
        }

        function getStatusInfo(status) {
            const statusMap = {
                'PENDING': { text: 'Chờ xác nhận', color: 'secondary' },
                'PROCESSING': { text: 'Chờ xử lý', color: 'warning' },
                'CONFIRMED': { text: 'Đã xác nhận', color: 'success' },
                'CHECKED_IN': { text: 'Đang ở', color: 'info' },
                'CHECKED_OUT': { text: 'Đã trả phòng', color: 'purple' },
                'CANCELLED': { text: 'Đã hủy', color: 'danger' }
            };
            return statusMap[status] || { text: status, color: 'primary' };
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('vi-VN');
        }

        // Status filter change handlers
        document.querySelectorAll('.status-filter').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const allStatusCheckboxes = document.querySelectorAll('.status-filter');
                const checkedStatusCheckboxes = document.querySelectorAll('.status-filter:checked');
                document.getElementById('status-all').checked = allStatusCheckboxes.length === checkedStatusCheckboxes.length;
                
                applyStatusFilter();
            });
        });

        document.querySelectorAll('.room-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', filterByRoom);
        });
    </script>
</body>
</html>
