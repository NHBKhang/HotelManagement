<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
    <head>
        <title th:text="${room.id != null} ? 'Chỉnh sửa Phòng - Quản lý khách sạn' : 'Thêm Phòng - Quản lý khách sạn'"></title>
    <th:block th:replace="base :: head"></th:block>
</head>
<body>
    <div th:replace="base :: layout(~{::content})">
        <div th:fragment="content">
            <div class="container">
                <h2 class="text-center mb-4">
                    <span th:if="${room.id != null}">
                        <i class="fa-solid fa-pen-to-square me-2"></i> Chỉnh sửa Phòng
                    </span>
                    <span th:unless="${room.id != null}">
                        <i class="fa-solid fa-plus me-2"></i> Thêm Phòng
                    </span>
                </h2>

                <form th:action="@{/rooms/save}" method="post" th:object="${room}"
                      class="styled-form" enctype="multipart/form-data">
                    <!-- Action buttons -->
                    <div class="my-3">
                        <button type="submit" class="btn btn-success me-2">
                            <i class="fa-solid fa-save me-1"></i>
                            <span th:text="${room.id != null} ? 'Cập nhật' : 'Lưu'"></span>
                        </button>
                        <button type="button" class="btn btn-danger" th:if="${room.id != null}"
                                th:onclick="|confirmAndRequest('@{/rooms/delete/{id}(id=${room.id})}', '@{/rooms}')|">
                            <i class="fa-solid fa-trash me-1"></i> Xóa
                        </button>
                        <a th:href="@{/rooms}" class="btn btn-secondary">
                            <i class="fa-solid fa-arrow-left me-1"></i> Quay lại
                        </a>
                    </div>

                    <div class="row">
                        <!-- Left column: form inputs -->
                        <div class="col-md-8">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fas fa-info-circle"></i> Thông tin Phòng</h5>
                                </div>
                                <div class="p-4 border rounded shadow-sm bg-light">
                                    <input type="hidden" th:if="${room.id != null}" th:field="*{id}">

                                    <div class="row mb-3">
                                        <div class="col-lg-8">
                                            <div class="mb-3" th:if="${room.id != null}">
                                                <label class="form-label fw-bold">Mã phòng</label>
                                                <span th:text="*{code}" class="badge bg-primary fs-6 fw-bold"></span>
                                                <input type="hidden" th:field="*{code}">
                                            </div>
                                            <div class="mb-3">
                                                <label for="roomNumber" class="form-label">Số phòng</label>
                                                <input type="text" id="roomNumber" th:field="*{roomNumber}" class="form-control" required>
                                                <p class="text-danger" th:if="${#fields.hasErrors('roomNumber')}" th:errors="*{roomNumber}"></p>
                                            </div>

                                            <!-- Loại phòng -->
                                            <div class="mb-3">
                                                <label for="roomType" class="form-label">Loại phòng</label>
                                                <div id="room-type-dropdown">
                                                    <input id="roomType" th:field="*{roomType.id}" required/>
                                                </div>
                                                <p class="text-danger" th:if="${#fields.hasErrors('roomType')}" th:errors="*{roomType}"></p>
                                            </div>
                                        </div>
                                        <div class="col-lg-4">
                                            <div class="text-center vertical"> 
                                                <img th:src="${room.image != null ? room.image : '/HotelManagementApp/img/default_room.jpg'}" class="border shadow-sm mb-2" width="149" height="149" alt="image" id="imagePreview"> 
                                                <input id="imageInput" type="file" class="form-control" th:field="*{file}" accept="image/*" onchange="previewImage(event)" style="display: none;"/> 
                                                <div class="d-flex justify-content-center gap-2">
                                                    <!-- Upload -->
                                                    <button type="button" class="btn btn-outline-primary btn-sm"
                                                            onclick="document.getElementById('imageInput').click()">
                                                        <i class="fa fa-upload"></i> Tải lên
                                                    </button>

                                                    <!-- Xóa -->
                                                    <button type="button" class="btn btn-outline-danger btn-sm"
                                                            onclick="removeImage()">
                                                        <i class="fa fa-trash"></i> Xóa
                                                    </button>
                                                </div>
                                            </div> 
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="size" class="form-label">Kích thước (m²)</label>
                                            <input type="number" id="size" th:field="*{size}" class="form-control"
                                                   min="0.01" max="1000" step="0.01" placeholder="Nhập diện tích phòng">
                                            <p class="text-danger" th:if="${#fields.hasErrors('size')}" th:errors="*{size}"></p>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="status" class="form-label">Trạng thái</label>
                                            <select id="status" th:field="*{status}" class="form-select">
                                                <option th:each="status : ${T(com.team.hotelmanagementapp.pojo.Room.Status).values()}"
                                                        th:value="${status}"
                                                        th:text="${status.description}"></option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Right column: summary -->
                        <div class="col-md-4">
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fas fa-receipt"></i> Tóm tắt</h5>
                                </div>
                                <div class="card-body">
                                    <ul class="list-unstyled">
                                        <li class="mb-2" th:if="${room.roomType != null}">
                                            <strong>Loại phòng:</strong> <span th:text="${room.roomType.name}"></span>
                                        </li>
                                        <li class="mb-2" th:if="${room.roomType != null}">
                                            <strong>Giá phòng:</strong> <span th:text="|${#numbers.formatDecimal(room.roomType.pricePerNight, 0, 'COMMA', 0, 'POINT')} đ|"></span>
                                        </li>
                                        <li class="mb-2" th:if="${room.roomType != null}">
                                            <strong>Số khách tối đa:</strong> <span th:text="|${room.roomType.maxGuests} khách|"></span>
                                        </li>
                                        <li class="mb-2" th:if="${room.size != null}">
                                            <strong>Kích thước:</strong> <span th:text="${room.size}"></span> m²
                                        </li>
                                    </ul>

                                    <div class="alert alert-info mt-3">
                                        <i class="fa-solid fa-lightbulb me-1"></i>
                                        Vui lòng đảm bảo thông tin chính xác trước khi lưu.
                                    </div>
                                </div>
                            </div>
                            <div class="card" th:if="${room.id}">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fas fa-history"></i> Lịch sử Cập nhật</h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-2">
                                        <strong>Ngày tạo:</strong><br>
                                        <span th:text="*{createdAt != null ? #temporals.format(createdAt, 'dd/MM/yyyy HH:mm') : 'N/A'}">01/01/2024 10:30</span>
                                    </div>
                                    <div class="mb-2">
                                        <strong>Cập nhật cuối:</strong><br>
                                        <span th:text="*{updatedAt != null ? #temporals.format(updatedAt, 'dd/MM/yyyy HH:mm') : 'N/A'}">01/01/2024 15:45</span>
                                    </div>
                                    <div class="mb-2">
                                        <strong>Trạng thái hiện tại:</strong>
                                        <span th:class="*{status != null ? status.badgeClass : 'badge bg-secondary'}" 
                                              th:text="*{status != null ? status.description : 'Chưa xác định'}">-</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        renderDynamicDropdown({
        containerId: 'room-type-dropdown',
                apiUrl: /*[[@{/api/room-types}]]*/,
                buildOptionText: item => item.name,
                value: {
                id: [[${room.roomType.id}]],
                        name: [[${room.roomType.name}]]
                },
                required: true
        });
        function removeImage() {
            document.getElementById("imagePreview").src = "/HotelManagementApp/img/default_room.jpg";
            document.getElementById("imageInput").value = "";
        }
    </script>
</body>
</html>
